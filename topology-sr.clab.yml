name: srv6-mesh

mgmt:
  network: fixedips
  ipv4-subnet: 172.100.100.0/24
  ipv6-subnet: 2001:172:100:100::/80

topology:
  defaults:
  nodes:
    # === SPINE ROUTERS (4 buah) ===
    router1:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.2
      mgmt-ipv6: 2001:172:100:100::2
      binds:
        - ./router1/frr.conf:/etc/frr/frr.conf
        - ./router1/daemons:/etc/frr/daemons
        - ./router1/init.sh:/etc/frr/init.sh
      exec:
        - /etc/frr/init.sh
    router2:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.3
      mgmt-ipv6: 2001:172:100:100::3
      binds:
        - ./router2/frr.conf:/etc/frr/frr.conf
        - ./router2/daemons:/etc/frr/daemons
        - ./router2/init.sh:/etc/frr/init.sh
      exec:
        - /etc/frr/init.sh
    router3:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.4
      mgmt-ipv6: 2001:172:100:100::4
      binds:
        - ./router3/frr.conf:/etc/frr/frr.conf
        - ./router3/daemons:/etc/frr/daemons
        - ./router3/init.sh:/etc/frr/init.sh
      exec:
        - /etc/frr/init.sh
    router4:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.5
      mgmt-ipv6: 2001:172:100:100::5
      binds:
        - ./router4/frr.conf:/etc/frr/frr.conf
        - ./router4/daemons:/etc/frr/daemons
        - ./router4/init.sh:/etc/frr/init.sh
      exec:
        - /etc/frr/init.sh

    # === LEAF ROUTERS (16 buah) ===
    router5:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.6
      mgmt-ipv6: 2001:172:100:100::6
      binds:
        - ./router5/frr.conf:/etc/frr/frr.conf
        - ./router5/daemons:/etc/frr/daemons
        - ./router5/init.sh:/etc/frr/init.sh
      exec:
        - /etc/frr/init.sh
    router6:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.7
      mgmt-ipv6: 2001:172:100:100::7
      binds:
        - ./router6/frr.conf:/etc/frr/frr.conf
        - ./router6/daemons:/etc/frr/daemons
        - ./router6/init.sh:/etc/frr/init.sh
      exec:
        - /etc/frr/init.sh
    router7:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.8
      mgmt-ipv6: 2001:172:100:100::8
      binds:
        - ./router7/frr.conf:/etc/frr/frr.conf
        - ./router7/daemons:/etc/frr/daemons
        - ./router7/init.sh:/etc/frr/init.sh
      exec:
        - /etc/frr/init.sh
    router8:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.9
      mgmt-ipv6: 2001:172:100:100::9
      binds:
        - ./router8/frr.conf:/etc/frr/frr.conf
        - ./router8/daemons:/etc/frr/daemons
        - ./router8/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router9:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.10
      mgmt-ipv6: 2001:172:100:100::10
      binds:
        - ./router9/frr.conf:/etc/frr/frr.conf
        - ./router9/daemons:/etc/frr/daemons
        - ./router9/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router10:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.11
      mgmt-ipv6: 2001:172:100:100::11
      binds:
        - ./router10/frr.conf:/etc/frr/frr.conf
        - ./router10/daemons:/etc/frr/daemons
        - ./router10/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router11:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.12
      mgmt-ipv6: 2001:172:100:100::12
      binds:
        - ./router11/frr.conf:/etc/frr/frr.conf
        - ./router11/daemons:/etc/frr/daemons
        - ./router11/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router12:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.13
      mgmt-ipv6: 2001:172:100:100::13
      binds:
        - ./router12/frr.conf:/etc/frr/frr.conf
        - ./router12/daemons:/etc/frr/daemons
        - ./router12/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router13:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.14
      mgmt-ipv6: 2001:172:100:100::14
      binds:
        - ./router13/frr.conf:/etc/frr/frr.conf
        - ./router13/daemons:/etc/frr/daemons
        - ./router13/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router14:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.15
      mgmt-ipv6: 2001:172:100:100::15
      binds:
        - ./router14/frr.conf:/etc/frr/frr.conf
        - ./router14/daemons:/etc/frr/daemons
        - ./router14/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router15:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.16
      mgmt-ipv6: 2001:172:100:100::16
      binds:
        - ./router15/frr.conf:/etc/frr/frr.conf
        - ./router15/daemons:/etc/frr/daemons
        - ./router15/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router16:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.17
      mgmt-ipv6: 2001:172:100:100::17
      binds:
        - ./router16/frr.conf:/etc/frr/frr.conf
        - ./router16/daemons:/etc/frr/daemons
        - ./router16/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router17:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.18
      mgmt-ipv6: 2001:172:100:100::18
      binds:
        - ./router17/frr.conf:/etc/frr/frr.conf
        - ./router17/daemons:/etc/frr/daemons
        - ./router17/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router18:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.19
      mgmt-ipv6: 2001:172:100:100::19
      binds:
        - ./router18/frr.conf:/etc/frr/frr.conf
        - ./router18/daemons:/etc/frr/daemons
        - ./router18/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router19:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.20
      mgmt-ipv6: 2001:172:100:100::20
      binds:
        - ./router19/frr.conf:/etc/frr/frr.conf
        - ./router19/daemons:/etc/frr/daemons
        - ./router19/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh
    router20:
      kind: linux
      image: sflow/clab-frr
      mgmt-ipv4: 172.100.100.21
      mgmt-ipv6: 2001:172:100:100::21
      binds:
        - ./router20/frr.conf:/etc/frr/frr.conf
        - ./router20/daemons:/etc/frr/daemons
        - ./router20/init.sh:/etc/frr/init.sh
      exec:
          - /etc/frr/init.sh

    # === CLIENT PCs ===
    pc1:
      kind: linux
      image: sflow/clab-iperf3
      mgmt-ipv4: 172.100.100.22
      mgmt-ipv6: 2001:172:100:100::22
      exec:
        - ip addr add 10.0.0.1/24 dev eth1
        - ip route replace default via 10.0.0.2 dev eth1
        - ip -6 addr add 2001:fa::2/64 dev eth1
        - ip -6 route replace default via 2001:fa::1 dev eth1
    pc2:
      kind: linux
      image: sflow/clab-iperf3
      mgmt-ipv4: 172.100.100.23
      mgmt-ipv6: 2001:172:100:100::23
      exec:
        - ip addr add 10.0.2.1/24 dev eth1
        - ip route replace default via 10.0.2.2 dev eth1
        - ip -6 addr add 2001:4b::2/64 dev eth1
        - ip -6 route replace default via 2001:4b::1 dev eth1

    # === MONITORING STACK ===
    sflow-rt:
      kind: linux
      image: sflow/prometheus
      mgmt-ipv4: 172.100.100.24
      mgmt-ipv6: 2001:172:100:100::24
      ports: [ "8008:8008", "6343:6343/udp" ]
    prometheus:
      kind: linux
      image: prom/prometheus:v2.47.0
      mgmt-ipv4: 172.100.100.25
      mgmt-ipv6: 2001:172:100:100::25
      ports: [ "9090:9090" ]
      binds: [ "./prometheus_ne.yml:/etc/prometheus/prometheus.yml" ]
    grafana:
      kind: linux
      image: grafana/grafana-oss
      mgmt-ipv4: 172.100.100.26
      mgmt-ipv6: 2001:172:100:100::26
      ports: [ "3000:3000" ]
      env:
        GF_SECURITY_ADMIN_USER: "admin"
        GF_SECURITY_ADMIN_PASSWORD: "admin"

  links:
    # === LEAF-SPINE CONNECTIONS (16 Leaves * 4 Spines = 64 Links) ===
    # --- Connections to Spine1 (router1) ---
    - endpoints: ["router1:eth1", "router5:eth1"]
    - endpoints: ["router1:eth2", "router6:eth1"]
    - endpoints: ["router1:eth3", "router7:eth1"]
    - endpoints: ["router1:eth4", "router8:eth1"]
    - endpoints: ["router1:eth5", "router9:eth1"]
    - endpoints: ["router1:eth6", "router10:eth1"]
    - endpoints: ["router1:eth7", "router11:eth1"]
    - endpoints: ["router1:eth8", "router12:eth1"]
    - endpoints: ["router1:eth9", "router13:eth1"]
    - endpoints: ["router1:eth10", "router14:eth1"]
    - endpoints: ["router1:eth11", "router15:eth1"]
    - endpoints: ["router1:eth12", "router16:eth1"]
    - endpoints: ["router1:eth13", "router17:eth1"]
    - endpoints: ["router1:eth14", "router18:eth1"]
    - endpoints: ["router1:eth15", "router19:eth1"]
    - endpoints: ["router1:eth16", "router20:eth1"]
    # --- Connections to Spine2 (router2) ---
    - endpoints: ["router2:eth1", "router5:eth2"]
    - endpoints: ["router2:eth2", "router6:eth2"]
    - endpoints: ["router2:eth3", "router7:eth2"]
    - endpoints: ["router2:eth4", "router8:eth2"]
    - endpoints: ["router2:eth5", "router9:eth2"]
    - endpoints: ["router2:eth6", "router10:eth2"]
    - endpoints: ["router2:eth7", "router11:eth2"]
    - endpoints: ["router2:eth8", "router12:eth2"]
    - endpoints: ["router2:eth9", "router13:eth2"]
    - endpoints: ["router2:eth10", "router14:eth2"]
    - endpoints: ["router2:eth11", "router15:eth2"]
    - endpoints: ["router2:eth12", "router16:eth2"]
    - endpoints: ["router2:eth13", "router17:eth2"]
    - endpoints: ["router2:eth14", "router18:eth2"]
    - endpoints: ["router2:eth15", "router19:eth2"]
    - endpoints: ["router2:eth16", "router20:eth2"]
    # --- Connections to Spine3 (router3) ---
    - endpoints: ["router3:eth1", "router5:eth3"]
    - endpoints: ["router3:eth2", "router6:eth3"]
    - endpoints: ["router3:eth3", "router7:eth3"]
    - endpoints: ["router3:eth4", "router8:eth3"]
    - endpoints: ["router3:eth5", "router9:eth3"]
    - endpoints: ["router3:eth6", "router10:eth3"]
    - endpoints: ["router3:eth7", "router11:eth3"]
    - endpoints: ["router3:eth8", "router12:eth3"]
    - endpoints: ["router3:eth9", "router13:eth3"]
    - endpoints: ["router3:eth10", "router14:eth3"]
    - endpoints: ["router3:eth11", "router15:eth3"]
    - endpoints: ["router3:eth12", "router16:eth3"]
    - endpoints: ["router3:eth13", "router17:eth3"]
    - endpoints: ["router3:eth14", "router18:eth3"]
    - endpoints: ["router3:eth15", "router19:eth3"]
    - endpoints: ["router3:eth16", "router20:eth3"]
    # --- Connections to Spine4 (router4) ---
    - endpoints: ["router4:eth1", "router5:eth4"]
    - endpoints: ["router4:eth2", "router6:eth4"]
    - endpoints: ["router4:eth3", "router7:eth4"]
    - endpoints: ["router4:eth4", "router8:eth4"]
    - endpoints: ["router4:eth5", "router9:eth4"]
    - endpoints: ["router4:eth6", "router10:eth4"]
    - endpoints: ["router4:eth7", "router11:eth4"]
    - endpoints: ["router4:eth8", "router12:eth4"]
    - endpoints: ["router4:eth9", "router13:eth4"]
    - endpoints: ["router4:eth10", "router14:eth4"]
    - endpoints: ["router4:eth11", "router15:eth4"]
    - endpoints: ["router4:eth12", "router16:eth4"]
    - endpoints: ["router4:eth13", "router17:eth4"]
    - endpoints: ["router4:eth14", "router18:eth4"]
    - endpoints: ["router4:eth15", "router19:eth4"]
    - endpoints: ["router4:eth16", "router20:eth4"]

    # === CLIENT CONNECTIONS ===
    - endpoints: ["pc1:eth1", "router5:eth5"]
    - endpoints: ["pc2:eth1", "router20:eth5"]